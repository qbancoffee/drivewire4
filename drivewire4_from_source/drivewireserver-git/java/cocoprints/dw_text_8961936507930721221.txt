PROCEDURE httpdDIM port_path:BYTEDIM port_name:STRING[4]DIM file_path:BYTEDIM errnum,tmp:INTEGERDIM reqstr:STRINGDIM reqid:BYTEDIM buffer(256):BYTEDIM tenbytes(10):BYTETYPE servin = id:BYTE; control:BYTE; dat:STRING[128]DIM srv_in:servinDIM hits,reqs:INTEGERDIM lf:BYTETYPE REGISTERS=CCR:BYTE; DR:INTEGER; DPR:BYTE; XR,YR,UR:INTEGERTYPE RREGISTERS=CC,A,B:BYTE; DP:BYTE; X,Y,U:INTEGERDIM regs:REGISTERSDIM rregs:RREGISTERSport_name="/N"hits=0reqs=0lf=10regs.DR = 0ON ERROR GOTO 10010 OPEN #port_path,port_name:UPDATE   PRINT "Using port ";port_name   GOTO 30   20 PRINT "Got busy, try next port.."   tmp := PEEK(ADDR(port_name)+2)   tmp := tmp + 1   POKE ADDR(port_name) + 2, tmp   GOTO 10   30 PRINT #port_path,"tcp listen 80 httpd"    GET #port_path,reqid   filepath = reqid   WHILE reqid <> 13 DO      PRINT CHR$(reqid);      GET #port_path,reqid   ENDWHILE      PRINT       IF filepath = 70 THEN    close #port_path    END   ENDIF   PRINT "Ready for connections..."   ON ERROR GOTO 200      REPEAT   40   REPEAT       GET #port_path,srv_in              IF LEFT$(srv_in.dat,3) = "GET" THEN         reqstr = TRIM$(RIGHT$(srv_in.dat,124))         reqid = srv_in.id       ENDIF            UNTIL (srv_in.control = 1) OR (srv_in.control = 0)           reqs = reqs + 1     IF srv_in.control = 1 THEN          print "REQ# ";reqs;"/";hits;": ";reqstr                    tmp = substr(" ",reqstr)          reqstr = left$(reqstr,tmp - 1)          IF reqstr = "/" THEN           reqstr = "/X1/WWWROOT/index.html"          ENDIF                    IF reqstr = "/favicon.ico" THEN           GOSUB 1099          ELSE            IF RIGHT$(reqstr,4) = ".gif" OR RIGHT$(reqstr,4) = ".jpg" OR RIGHT$(reqstr,5) = ".html" THEN                       rem check for file             ON ERROR GOTO 300             OPEN #file_path,reqstr:READ                       ON ERROR GOTO 200                       PRINT #port_path,"HTTP/1.1 200 OK"             PUT #port_path,lf             PRINT #port_path,"Server: COCO OS9 DriveWire"             PUT #port_path,lf                       IF RIGHT$(reqstr,4) = ".gif" THEN               PRINT #port_path,"Content-Type: image/gif"               PUT #port_path,lf             ENDIF                           IF RIGHT$(reqstr,4) = ".jpg" THEN               PRINT #port_path,"Content-Type: image/jpeg"               PUT #port_path,lf             ENDIF                       PRINT #port_path,"Connection: close"             PUT #port_path,lf             PRINT #port_path,CHR$(13);             PUT #port_path,lf                                     REPEAT               (* use I$Read for speed *)               rregs.A = file_path               rregs.Y = 256               rregs.X = ADDR(buffer)               reqid = $89               RUN SYSCALL(reqid,rregs)                (* now Y has bytes read, lets write them)               rregs.A = port_path               rregs.X = ADDR(buffer)               reqid = $8A               RUN SYSCALL(reqid,rregs)              UNTIL EOF(#file_path)                    CLOSE #file_path                        ENDIF                      ENDIF                        PRINT #port_path,CHR$(0)               ENDIF        UNTIL srv_in.control = 0        CLOSE #port_path   END100 errnum := ERR   IF errnum = 250 THEN      PRINT "BUSY ON PORT ";port_name      GOTO 20   ELSE      PRINT "ERROR ";errnum;" ON PORT ";port_name      END   ENDIF         200 errnum := ERR PRINT "ERROR ";errnum CLOSE #port_path REM GOTO 40 END 300 errnum := ERR ON ERROR GOTO 200 GOSUB 1050 PRINT #port_path,"<HTML><HEAD><TITLE>File not found</TITLE></HEAD><BODY><H3>File not found</BODY></HTML>" PRINT #port_path,CHR$(0) GOTO 40 1000 PRINT #port_path,CHR$(0) RETURN1050 PRINT #port_path,"HTTP/1.1 200 OK"     PUT #port_path,lf     PRINT #port_path,"Server: COCO OS9 DriveWire"     PUT #port_path,lf     PRINT #port_path,"Connection: close"     PUT #port_path,lf     PRINT #port_path,"Cache-Control: no-cache"     PUT #port_path,lf     PRINT #port_path,CHR$(13);     PUT #port_path,lf     RETURN     REM favicon.ico1099 RESTORE 1100     PRINT #port_path,"HTTP/1.1 200 OK"     PUT #port_path,lf     PRINT #port_path,"Content-Type: image/x-icon"     PUT #port_path,lf     PRINT #port_path,"Connection: close"     PUT #port_path,lf     PRINT #port_path,"Cache-Control: public, max-age=31536000"     PUT #port_path,lf     PRINT #port_path,CHR$(13);     PUT #port_path,lf          FOR tmp = 1 to 115      READ tenbytes(1),tenbytes(2),tenbytes(3),tenbytes(4),tenbytes(5),tenbytes(6),tenbytes(7),tenbytes(8),tenbytes(9),tenbytes(10)     PUT #port_path,tenbytes     NEXT tmp          RETURN1100 DATA $0,$0,$1,$0,$1,$0,$10,$10,$0,$0DATA $1,$0,$20,$0,$68,$4,$0,$0,$16,$0DATA $0,$0,$28,$0,$0,$0,$10,$0,$0,$0DATA $20,$0,$0,$0,$1,$0,$20,$0,$0,$0DATA $0,$0,$0,$4,$0,$0,$0,$0,$0,$0DATA $0,$0,$0,$0,$0,$0,$0,$0,$0,$0DATA $0,$0,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$0,$0,$ffDATA $0,$0,$0,$ff,$0,$0,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$0,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$0DATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$0,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$0,$0,$ff,$0,$ff,$0,$ffDATA $0,$0,$0,$ff,$0,$ff,$0,$ff,$0,$0DATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$0,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$0,$0,$ffDATA $0,$ff,$0,$ff,$0,$0,$0,$ff,$0,$0DATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$0,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$0,$0,$ff,$0,$ff,$0,$ff,$0,$0DATA $0,$ff,$0,$ff,$0,$ff,$0,$0,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$0,$0,$ff,$0,$0,$0,$ffDATA $0,$0,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$0,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$0,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$ff,$0,$ffDATA $0,$ff,$0,$ff,$0,$ff,$0,$0,$0,$0DATA $0,$0,$0,$0,$0,$0,$0,$0,$0,$0DATA $0,$0,$0,$0,$0,$0,$0,$0,$0,$0DATA $0,$0,$0,$0,$0,$0,$0,$0,$0,$0DATA $0,$0,$0,$0,$0,$0,$0,$0,$0,$0DATA $0,$0,$0,$0,$0,$0,$0,$0,$0,$0DATA $0,$0,$0,$0,$0,$0,$0,$0,$0,$0